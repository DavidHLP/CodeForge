# LogCommons 使用示例

## 快速开始

### Maven 依赖配置

```xml
<dependency>
    <groupId>com.david</groupId>
    <artifactId>log-commons</artifactId>
    <version>0.0.1-SNAPSHOT</version>
</dependency>
```

### 最简配置

LogCommons 支持零配置启动，但推荐在 `application.yml` 中进行基础配置：

```yaml
log-commons:
  enabled: true
  default-async: true
  modules:
    business:
      enabled: true
      level: INFO
    performance:
      enabled: true  
      level: DEBUG
    security:
      enabled: true
      level: WARN
    exception:
      enabled: true
      level: ERROR
```

## 基础使用示例

### 1. 静态导入方式（推荐）

```java
import static com.david.log.commons.core.LogUtils.*;

@Service
public class UserService {
    
    public User createUser(UserCreateRequest request) {
        // 记录业务操作开始
        business().audit(request.getUserId(), "createUser", "started", request.getUsername());
        
        try {
            // 业务逻辑执行
            User user = performUserCreation(request);
            
            // 记录成功事件
            business().event("USER_CREATED", user.getId(), user.getUsername(), user.getEmail());
            
            return user;
        } catch (Exception e) {
            // 记录异常
            exception().business("createUser", e, request);
            throw e;
        }
    }
}
```

### 2. 依赖注入方式

```java
@Service
public class OrderService {
    
    // 可以直接注入具体的操作接口
    @Autowired
    private BusinessLogOperations businessLog;
    
    @Autowired
    private PerformanceLogOperations performanceLog;
    
    public Order processOrder(OrderRequest request) {
        long startTime = System.currentTimeMillis();
        
        businessLog.trace(request.getOrderId(), "processOrder", "started", request);
        
        try {
            Order order = doProcessOrder(request);
            
            long duration = System.currentTimeMillis() - startTime;
            performanceLog.timing("processOrder", duration, request.getOrderId());
            
            return order;
        } catch (Exception e) {
            businessLog.trace(request.getOrderId(), "processOrder", "failed", e.getMessage());
            throw e;
        }
    }
}
```

## 业务日志示例

### 用户操作审计

```java
@RestController
@RequestMapping("/api/users")
public class UserController {
    
    @PostMapping
    public ResponseEntity<User> createUser(@RequestBody UserCreateRequest request) {
        String userId = getCurrentUserId();
        
        // 记录用户创建操作审计
        business().audit(userId, "createUser", "attempt", 
            request.getUsername(), request.getEmail());
        
        try {
            User user = userService.createUser(request);
            
            // 记录成功审计
            business().audit(userId, "createUser", "success", 
                user.getId(), user.getUsername());
            
            return ResponseEntity.ok(user);
            
        } catch (ValidationException e) {
            business().audit(userId, "createUser", "validation_failed", 
                e.getField(), e.getMessage());
            throw e;
            
        } catch (Exception e) {
            business().audit(userId, "createUser", "system_error", 
                e.getClass().getSimpleName());
            throw e;
        }
    }
    
    @DeleteMapping("/{id}")
    public ResponseEntity<Void> deleteUser(@PathVariable String id) {
        String operatorId = getCurrentUserId();
        
        business().audit(operatorId, "deleteUser", "attempt", id);
        
        userService.deleteUser(id);
        
        business().audit(operatorId, "deleteUser", "success", id);
        
        return ResponseEntity.noContent().build();
    }
}
```

### 业务流程追踪

```java
@Service
public class OrderProcessService {
    
    public void processOrder(String orderId) {
        // 开始订单处理流程
        business().trace(orderId, "orderProcess", "started");
        
        try {
            // 步骤1：验证订单
            business().trace(orderId, "validateOrder", "started");
            validateOrder(orderId);
            business().trace(orderId, "validateOrder", "completed");
            
            // 步骤2：库存检查
            business().trace(orderId, "checkInventory", "started");
            boolean inventoryOk = checkInventory(orderId);
            business().trace(orderId, "checkInventory", 
                inventoryOk ? "sufficient" : "insufficient");
            
            // 步骤3：支付处理
            business().trace(orderId, "processPayment", "started");
            PaymentResult result = processPayment(orderId);
            business().trace(orderId, "processPayment", result.getStatus(), 
                result.getTransactionId());
            
            // 步骤4：发货
            business().trace(orderId, "shipOrder", "started");
            String trackingNumber = shipOrder(orderId);
            business().trace(orderId, "shipOrder", "completed", trackingNumber);
            
            // 流程完成
            business().trace(orderId, "orderProcess", "completed");
            
        } catch (Exception e) {
            business().trace(orderId, "orderProcess", "failed", e.getMessage());
            throw e;
        }
    }
}
```

### 业务事件记录

```java
@Service
public class GameService {
    
    public void submitSolution(String userId, String problemId, String code) {
        try {
            // 提交代码判题
            JudgeResult result = judgeEngine.judge(problemId, code);
            
            // 记录判题事件
            business().event("SOLUTION_SUBMITTED", 
                userId, problemId, result.getStatus(), 
                result.getScore(), result.getExecutionTime());
            
            if (result.isAccepted()) {
                // 记录AC事件
                business().event("PROBLEM_SOLVED", 
                    userId, problemId, result.getLanguage());
                    
                // 检查是否首次AC
                if (isFirstAC(userId, problemId)) {
                    business().event("FIRST_AC", userId, problemId);
                }
            }
            
        } catch (Exception e) {
            business().event("JUDGE_ERROR", userId, problemId, e.getMessage());
            exception().business("submitSolution", e, userId, problemId);
        }
    }
    
    public void updateRating(String userId, int oldRating, int newRating) {
        business().event("RATING_UPDATED", 
            userId, oldRating, newRating, newRating - oldRating);
            
        // 记录等级变化
        String oldLevel = getRatingLevel(oldRating);
        String newLevel = getRatingLevel(newRating);
        if (!oldLevel.equals(newLevel)) {
            business().event("LEVEL_CHANGED", userId, oldLevel, newLevel);
        }
    }
}
```

## 性能日志示例

### 方法执行时间监控

```java
@Service
public class DataAnalysisService {
    
    public AnalysisResult analyzeUserBehavior(String userId, TimeRange range) {
        long startTime = System.currentTimeMillis();
        
        try {
            // 执行分析逻辑
            AnalysisResult result = performAnalysis(userId, range);
            
            long duration = System.currentTimeMillis() - startTime;
            
            // 记录性能日志
            performance().timing("analyzeUserBehavior", duration, 
                userId, range.getDays(), result.getDataPoints());
            
            return result;
            
        } catch (Exception e) {
            long duration = System.currentTimeMillis() - startTime;
            performance().timing("analyzeUserBehavior", duration, 
                userId, "ERROR", e.getMessage());
            throw e;
        }
    }
    
    @Async
    public CompletableFuture<ReportResult> generateReport(String reportId) {
        long startTime = System.currentTimeMillis();
        
        try {
            ReportResult result = doGenerateReport(reportId);
            
            long duration = System.currentTimeMillis() - startTime;
            performance().timing("generateReport", duration, 
                reportId, result.getPages(), result.getSize());
            
            return CompletableFuture.completedFuture(result);
            
        } catch (Exception e) {
            long duration = System.currentTimeMillis() - startTime;
            performance().timing("generateReport", duration, 
                reportId, "ERROR");
            throw e;
        }
    }
}
```

### 数据库性能监控

```java
@Repository
public class UserRepository {
    
    @Autowired
    private JdbcTemplate jdbcTemplate;
    
    public List<User> findUsersByCondition(UserQueryCondition condition) {
        String sql = "SELECT * FROM users WHERE status = ? AND create_time > ?";
        long startTime = System.currentTimeMillis();
        
        try {
            List<User> users = jdbcTemplate.query(sql, 
                new UserRowMapper(), 
                condition.getStatus(), 
                condition.getCreateTimeAfter());
            
            long duration = System.currentTimeMillis() - startTime;
            
            // 记录SQL性能
            performance().sql(sql, duration, users.size(), 
                condition.getStatus(), condition.getCreateTimeAfter());
            
            return users;
            
        } catch (Exception e) {
            long duration = System.currentTimeMillis() - startTime;
            performance().sql(sql, duration, 0, "ERROR", e.getMessage());
            throw e;
        }
    }
    
    public void batchInsertUsers(List<User> users) {
        String sql = "INSERT INTO users (username, email, status) VALUES (?, ?, ?)";
        long startTime = System.currentTimeMillis();
        
        try {
            jdbcTemplate.batchUpdate(sql, users, users.size(),
                (ps, user) -> {
                    ps.setString(1, user.getUsername());
                    ps.setString(2, user.getEmail());
                    ps.setString(3, user.getStatus());
                });
            
            long duration = System.currentTimeMillis() - startTime;
            performance().sql("BATCH_INSERT_USERS", duration, users.size());
            
        } catch (Exception e) {
            long duration = System.currentTimeMillis() - startTime;
            performance().sql("BATCH_INSERT_USERS", duration, 0, "ERROR");
            throw e;
        }
    }
}
```

### HTTP 请求性能监控

```java
@Component
public class HttpPerformanceInterceptor implements HandlerInterceptor {
    
    private static final String START_TIME_ATTR = "startTime";
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) {
        request.setAttribute(START_TIME_ATTR, System.currentTimeMillis());
        return true;
    }
    
    @Override
    public void afterCompletion(HttpServletRequest request, 
                               HttpServletResponse response, 
                               Object handler, 
                               Exception ex) {
        Long startTime = (Long) request.getAttribute(START_TIME_ATTR);
        if (startTime != null) {
            long duration = System.currentTimeMillis() - startTime;
            
            // 记录HTTP请求性能
            performance().http(
                request.getMethod(),
                request.getRequestURI(),
                response.getStatus(),
                duration);
        }
    }
}
```

### 系统资源监控

```java
@Component
@Scheduled(fixedRate = 30000) // 每30秒执行一次
public class SystemMetricsCollector {
    
    private final MemoryMXBean memoryBean = ManagementFactory.getMemoryMXBean();
    private final List<GarbageCollectorMXBean> gcBeans = 
        ManagementFactory.getGarbageCollectorMXBeans();
    
    @Scheduled(fixedRate = 30000)
    public void collectMemoryMetrics() {
        MemoryUsage heapUsage = memoryBean.getHeapMemoryUsage();
        
        // 记录堆内存使用情况
        performance().memory("heap", 
            heapUsage.getUsed(), 
            heapUsage.getMax());
        
        MemoryUsage nonHeapUsage = memoryBean.getNonHeapMemoryUsage();
        
        // 记录非堆内存使用情况  
        performance().memory("non-heap", 
            nonHeapUsage.getUsed(), 
            nonHeapUsage.getMax());
    }
    
    @Scheduled(fixedRate = 60000) 
    public void collectGCMetrics() {
        for (GarbageCollectorMXBean gcBean : gcBeans) {
            String gcName = gcBean.getName();
            long collections = gcBean.getCollectionCount();
            long time = gcBean.getCollectionTime();
            
            performance().metric("gc_collections", collections, "gc", gcName);
            performance().metric("gc_time", time, "gc", gcName);
        }
    }
}
```

## 安全日志示例

### 用户认证日志

```java
@Service
public class AuthenticationService {
    
    public LoginResult login(LoginRequest request, HttpServletRequest httpRequest) {
        String username = request.getUsername();
        String password = request.getPassword();
        String clientIp = getClientIp(httpRequest);
        String userAgent = httpRequest.getHeader("User-Agent");
        
        try {
            // 尝试认证
            User user = authenticateUser(username, password);
            
            if (user != null) {
                // 登录成功
                security().login(username, password, true, clientIp, userAgent);
                
                // 记录登录事件
                business().event("USER_LOGIN", user.getId(), clientIp, userAgent);
                
                return LoginResult.success(user);
                
            } else {
                // 认证失败
                security().login(username, password, false, clientIp, userAgent);
                
                // 检查是否为暴力破解攻击
                if (isThresholdExceeded(clientIp, username)) {
                    security().threat("BRUTE_FORCE", "HIGH", 
                        "检测到暴力破解攻击", clientIp, username);
                }
                
                return LoginResult.failure("用户名或密码错误");
            }
            
        } catch (Exception e) {
            security().login(username, password, false, clientIp, "SYSTEM_ERROR");
            exception().system("AuthenticationService", e, "CRITICAL");
            throw e;
        }
    }
    
    public void logout(String userId, String sessionId, String reason) {
        security().logout(userId, sessionId, reason);
        business().event("USER_LOGOUT", userId, reason);
    }
}
```

### 权限检查日志

```java
@Component
public class SecurityAspect {
    
    @Around("@annotation(requiresPermission)")
    public Object checkPermission(ProceedingJoinPoint joinPoint, 
                                 RequiresPermission requiresPermission) throws Throwable {
        
        String userId = getCurrentUserId();
        String resource = requiresPermission.resource();
        String action = requiresPermission.action();
        
        try {
            // 检查权限
            boolean granted = permissionService.hasPermission(userId, resource, action);
            
            // 记录权限检查
            security().permission(userId, resource, action, granted);
            
            if (!granted) {
                // 记录权限拒绝事件
                business().event("PERMISSION_DENIED", userId, resource, action);
                throw new SecurityException("权限不足");
            }
            
            // 执行目标方法
            return joinPoint.proceed();
            
        } catch (Exception e) {
            security().permission(userId, resource, action, false, e.getMessage());
            throw e;
        }
    }
}
```

### 敏感数据访问审计

```java
@Service
public class SensitiveDataService {
    
    public List<PersonalInfo> getPersonalInfoBatch(List<String> userIds) {
        String operatorId = getCurrentUserId();
        
        // 记录敏感数据访问
        security().dataAccess(operatorId, "personal_info", "batch_read", userIds.size());
        
        try {
            List<PersonalInfo> result = personalInfoRepository.findByUserIds(userIds);
            
            // 记录成功访问的数量
            security().dataAccess(operatorId, "personal_info", "batch_read_success", 
                result.size());
            
            return result;
            
        } catch (Exception e) {
            security().dataAccess(operatorId, "personal_info", "batch_read_error", 0);
            throw e;
        }
    }
    
    public void updateSensitiveField(String userId, String field, String newValue) {
        String operatorId = getCurrentUserId();
        
        // 记录敏感字段修改
        security().dataAccess(operatorId, "sensitive_field", "update", 
            userId, field);
            
        business().audit(operatorId, "updateSensitiveField", "attempt", 
            userId, field);
        
        try {
            sensitiveDataRepository.updateField(userId, field, newValue);
            
            business().audit(operatorId, "updateSensitiveField", "success", 
                userId, field);
                
        } catch (Exception e) {
            business().audit(operatorId, "updateSensitiveField", "failed", 
                userId, field, e.getMessage());
            throw e;
        }
    }
}
```

## 异常日志示例

### 业务异常处理

```java
@Service
public class OrderService {
    
    public Order createOrder(OrderCreateRequest request) {
        try {
            // 验证订单数据
            validateOrderRequest(request);
            
            // 检查库存
            if (!inventoryService.checkAvailability(request.getItems())) {
                throw new BusinessException("库存不足", "INSUFFICIENT_INVENTORY");
            }
            
            // 创建订单
            Order order = buildOrder(request);
            orderRepository.save(order);
            
            return order;
            
        } catch (ValidationException e) {
            // 记录验证异常
            exception().validation(e.getField(), e.getValue(), 
                e.getRule(), e.getMessage());
            throw e;
            
        } catch (BusinessException e) {
            // 记录业务异常
            exception().business("createOrder", e, request, e.getErrorCode());
            throw e;
            
        } catch (DataAccessException e) {
            // 记录数据库异常
            exception().database("INSERT INTO orders", e, request.getUserId());
            throw new SystemException("订单创建失败", e);
            
        } catch (Exception e) {
            // 记录系统异常
            exception().system("OrderService", e, "HIGH");
            throw new SystemException("系统异常", e);
        }
    }
}
```

### 网络异常处理

```java
@Service
public class ExternalApiService {
    
    @Retryable(value = {ConnectException.class, SocketTimeoutException.class}, 
               maxAttempts = 3, backoff = @Backoff(delay = 1000))
    public ApiResponse callExternalApi(ApiRequest request) {
        String endpoint = getApiEndpoint();
        int attempt = getCurrentAttempt(); // 获取当前重试次数
        
        try {
            ApiResponse response = restTemplate.postForObject(endpoint, request, ApiResponse.class);
            
            if (response == null || !response.isSuccess()) {
                BusinessException e = new BusinessException("API调用失败: " + response.getErrorMessage());
                exception().network(endpoint, e, attempt);
                throw e;
            }
            
            return response;
            
        } catch (ResourceAccessException e) {
            // 网络连接异常
            exception().network(endpoint, e, attempt);
            throw e;
            
        } catch (HttpClientErrorException e) {
            // HTTP客户端错误 
            exception().network(endpoint, e, attempt, 
                e.getStatusCode().value(), e.getResponseBodyAsString());
            throw new BusinessException("API调用失败: " + e.getMessage(), e);
            
        } catch (HttpServerErrorException e) {
            // HTTP服务端错误
            exception().network(endpoint, e, attempt, 
                e.getStatusCode().value(), e.getResponseBodyAsString());
            throw new SystemException("外部服务异常", e);
        }
    }
    
    @Recover
    public ApiResponse recover(Exception e, ApiRequest request) {
        // 重试全部失败后的恢复处理
        exception().network(getApiEndpoint(), e, 3, "FINAL_FAILURE");
        return ApiResponse.failure("服务暂时不可用");
    }
}
```

## 高级使用场景

### 分布式链路追踪

```java
@Service
public class DistributedService {
    
    public void processDistributedTask(String taskId) {
        // 生成或获取 traceId
        String traceId = MDC.get("traceId");
        if (traceId == null) {
            traceId = UUID.randomUUID().toString();
            MDC.put("traceId", traceId);
        }
        
        // 构建带链路ID的日志上下文
        LogContext context = LogContext.builder()
            .operation("processDistributedTask")
            .module("DistributedService")
            .traceId(traceId)
            .message("开始处理分布式任务")
            .args(new Object[]{taskId})
            .build();
        
        business().trace(taskId, "distributedTask", "started", traceId);
        
        try {
            // 调用服务A
            callServiceA(taskId, traceId);
            
            // 调用服务B
            callServiceB(taskId, traceId);
            
            business().trace(taskId, "distributedTask", "completed", traceId);
            
        } catch (Exception e) {
            exception().business("processDistributedTask", e, taskId, traceId);
            business().trace(taskId, "distributedTask", "failed", traceId, e.getMessage());
            throw e;
        } finally {
            MDC.remove("traceId");
        }
    }
    
    private void callServiceA(String taskId, String traceId) {
        // 传递 traceId 到下游服务
        HttpHeaders headers = new HttpHeaders();
        headers.add("X-Trace-Id", traceId);
        
        business().trace(taskId, "callServiceA", "started", traceId);
        
        // ... 调用逻辑
        
        business().trace(taskId, "callServiceA", "completed", traceId);
    }
}
```

### 条件化日志记录

```java
@Configuration
@EnableConfigurationProperties(LogCommonsProperties.class)
public class ConditionalLoggingExample {
    
    @Service
    public class ConditionalLogService {
        
        @Value("${app.debug-mode:false}")
        private boolean debugMode;
        
        public void processData(DataRequest request) {
            // 根据条件记录详细日志
            if (debugMode) {
                business().trace(request.getId(), "processData", "debug_mode", 
                    request.toString());
            } else {
                business().trace(request.getId(), "processData", "started");
            }
            
            long startTime = System.currentTimeMillis();
            
            try {
                DataResult result = doProcessData(request);
                
                long duration = System.currentTimeMillis() - startTime;
                
                // 性能日志总是记录
                performance().timing("processData", duration, request.getId());
                
                // 只在debug模式下记录详细结果
                if (debugMode) {
                    business().trace(request.getId(), "processData", "completed", 
                        result.toString());
                }
                
            } catch (Exception e) {
                long duration = System.currentTimeMillis() - startTime;
                performance().timing("processData", duration, request.getId(), "ERROR");
                exception().business("processData", e, request);
                throw e;
            }
        }
    }
}
```

### 批量操作日志

```java
@Service
public class BatchOperationService {
    
    public BatchResult processBatch(List<BatchItem> items) {
        String batchId = generateBatchId();
        int total = items.size();
        
        business().trace(batchId, "batchProcess", "started", total);
        
        long startTime = System.currentTimeMillis();
        BatchResult result = new BatchResult();
        
        for (int i = 0; i < items.size(); i++) {
            BatchItem item = items.get(i);
            
            try {
                processItem(item);
                result.addSuccess(item.getId());
                
                // 每100个记录一次进度
                if ((i + 1) % 100 == 0) {
                    business().trace(batchId, "batchProcess", "progress", 
                        i + 1, total);
                }
                
            } catch (Exception e) {
                result.addError(item.getId(), e.getMessage());
                exception().business("processBatchItem", e, 
                    batchId, item.getId(), i);
            }
        }
        
        long duration = System.currentTimeMillis() - startTime;
        
        // 记录批量处理结果
        business().trace(batchId, "batchProcess", "completed", 
            result.getSuccessCount(), result.getErrorCount(), duration);
            
        performance().timing("processBatch", duration, 
            total, result.getSuccessCount(), result.getErrorCount());
        
        return result;
    }
}
```

LogCommons 组件通过这些丰富的使用示例，展现了其在各种业务场景下的强大能力。无论是简单的操作记录，还是复杂的分布式链路追踪，都能够提供简洁易用的 API 和强大的功能支持。
