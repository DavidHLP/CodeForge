# SpringOJ 微服务权限信息传递系统 - 核心模块

## 1. 模块架构概览

### 1.1 模块依赖关系图

```mermaid
graph TB
    subgraph "SpringOJ-gateway 网关服务"
        A[AuthGlobalFilter<br/>全局认证过滤器]
        B[AuthFeignClient<br/>认证服务客户端]
        C[SecurityConfiguration<br/>安全配置]
        D[WebClientConfig<br/>WebClient配置]
    end

    subgraph "SpringOJ-commons 公共组件"
        E[security-commons<br/>安全公共组件]
        F[servlet-commons<br/>Servlet支持]
        G[webflux-commons<br/>WebFlux支持]
    end

    subgraph "security-commons 核心类"
        H[AuthUser<br/>认证用户实体]
        I[UserContextUtil<br/>用户上下文工具]
        J[AuthenticationFilter<br/>认证过滤器]
        K[BaseController<br/>基础控制器]
    end

    A --> B
    A --> H
    B --> H
    C --> A
    J --> I
    J --> H
    K --> I

    E --> H
    E --> I
    E --> J
    E --> K

    F --> L[GlobalExceptionHandler<br/>Servlet异常处理]
    G --> M[GlobalExceptionHandlerWebFlux<br/>WebFlux异常处理]
```

## 2. 网关核心模块

### 2.1 AuthGlobalFilter 类设计

```mermaid
classDiagram
    class AuthGlobalFilter {
        -String BEARER_PREFIX = "Bearer "
        -String HEADER_AUTHORIZATION = "Authorization"
        -String HEADER_USER_ID = "X-User-Id"
        -String HEADER_USER_NAME = "X-User-Name"
        -String HEADER_USER_EMAIL = "X-User-Email"
        -String HEADER_USER_ROLES = "X-User-Roles"
        -List~String~ PUBLIC_PATHS
        -AuthFeignClient authFeignClient

        +filter(ServerWebExchange, GatewayFilterChain) Mono~Void~
        +getOrder() int
        -handleUnauthorized(ServerHttpResponse, String) Mono~Void~
    }

    class GlobalFilter {
        <<interface>>
        +filter(ServerWebExchange, GatewayFilterChain) Mono~Void~
    }

    class Ordered {
        <<interface>>
        +getOrder() int
    }

    class AuthFeignClient {
        <<interface>>
        +loadUserByUsername(String) ResponseResult~AuthUserInfo~
    }

    AuthGlobalFilter --|> GlobalFilter
    AuthGlobalFilter --|> Ordered
    AuthGlobalFilter --> AuthFeignClient
```

**核心功能：**

- **请求拦截**：拦截所有进入网关的请求
- **路径过滤**：公开路径直接放行，需认证路径进行token验证
- **Token验证**：提取Bearer Token并调用认证服务验证
- **信息注入**：将用户信息注入到请求头中传递给下游服务
- **异常处理**：统一处理认证失败场景，返回401错误

### 2.2 AuthFeignClient 接口设计

```mermaid
classDiagram
    class AuthFeignClient {
        <<interface>>
        +loadUserByUsername(String token) ResponseResult~AuthUserInfo~
    }

    class FeignClient {
        <<annotation>>
        +name() String
        +path() String
    }

    class GetMapping {
        <<annotation>>
        +value() String
    }

    class PathVariable {
        <<annotation>>
        +value() String
    }

    AuthFeignClient --> FeignClient : @FeignClient(name="authentication")
    AuthFeignClient --> GetMapping : @GetMapping("/validate/{token}")
    AuthFeignClient --> PathVariable : @PathVariable("token")
```

**设计特点：**

- **服务发现**：通过name="authentication"自动发现认证服务
- **负载均衡**：自动集成LoadBalancer进行负载均衡
- **异常处理**：支持熔断、重试等容错机制
- **类型安全**：强类型返回值，避免运行时错误

### 2.3 SecurityConfiguration 配置类

```mermaid
classDiagram
    class SecurityConfiguration {
        -String[] PUBLIC_PATHS
        +securityWebFilterChain(ServerHttpSecurity) SecurityWebFilterChain
    }

    class Configuration {
        <<annotation>>
    }

    class EnableWebFluxSecurity {
        <<annotation>>
    }

    class Bean {
        <<annotation>>
    }

    SecurityConfiguration --> Configuration
    SecurityConfiguration --> EnableWebFluxSecurity
    SecurityConfiguration --> Bean
```

**配置要点：**

- **WebFlux支持**：专门为响应式网关设计
- **简化配置**：主要权限控制交给AuthGlobalFilter处理
- **路径配置**：定义公开路径，无需认证直接访问
- **无状态设计**：禁用session，使用JWT无状态认证

## 3. 安全公共组件模块

### 3.1 AuthUser 用户实体类

```mermaid
classDiagram
    class AuthUser {
        -Long userId
        -String username
        -String avatar
        -String introduction
        -String email
        -Integer status
        -String address
        -String lastLoginIp
        -LocalDateTime lastLogin
        -LocalDateTime createTime
        -String password
        -List~Role~ roles
        -Role role

        +getAuthorities() Collection~GrantedAuthority~
        +isAccountNonExpired() boolean
        +isAccountNonLocked() boolean
        +isCredentialsNonExpired() boolean
        +isEnabled() boolean
        +hasRole(String) boolean
        +isAdmin() boolean
        +getRoleName() String
    }

    class UserDetails {
        <<interface>>
        +getAuthorities() Collection~GrantedAuthority~
        +getPassword() String
        +getUsername() String
        +isAccountNonExpired() boolean
        +isAccountNonLocked() boolean
        +isCredentialsNonExpired() boolean
        +isEnabled() boolean
    }

    class Role {
        -Long roleId
        -String roleName
        -String description
        -Integer status
        -LocalDateTime createTime
    }

    AuthUser --|> UserDetails
    AuthUser --> Role : contains
```

**设计优势：**

- **Spring Security集成**：实现UserDetails接口，无缝集成
- **权限支持**：支持多角色和权限管理
- **状态管理**：支持账户状态、锁定状态等控制
- **扩展性**：支持用户基础信息和扩展字段

### 3.2 UserContextUtil 工具类

```mermaid
classDiagram
    class UserContextUtil {
        +String USER_ID_HEADER = "X-User-Id"
        +String USER_NAME_HEADER = "X-User-Name"
        +String USER_EMAIL_HEADER = "X-User-Email"
        +String USER_ROLES_HEADER = "X-User-Roles"

        +getCurrentUserId(ServerWebExchange) Optional~Long~
        +getCurrentUsername(ServerWebExchange) Optional~String~
        +getCurrentUserEmail(ServerWebExchange) Optional~String~
        +getCurrentUserRole(ServerWebExchange) Optional~String~
        +hasRole(ServerWebExchange, String) boolean
        +isAdmin(ServerWebExchange) boolean
        +isCurrentUser(ServerWebExchange, Long) boolean
        +getCurrentAuthUser(ServerWebExchange) Optional~AuthUser~

        +getCurrentUserId(HttpServletRequest) Optional~Long~
        +getCurrentUsername(HttpServletRequest) Optional~String~
        +getCurrentUserEmail(HttpServletRequest) Optional~String~
        +getCurrentUserRole(HttpServletRequest) Optional~String~
        +hasRole(HttpServletRequest, String) boolean
        +isAdmin(HttpServletRequest) boolean
        +isCurrentUser(HttpServletRequest, Long) boolean
        +getCurrentAuthUser(HttpServletRequest) Optional~AuthUser~

        +getCurrentAuthentication() Mono~Authentication~
        +getCurrentUsernameFromContext() Mono~String~
    }

    class ServerWebExchange {
        <<interface>>
    }

    class HttpServletRequest {
        <<interface>>
    }

    UserContextUtil --> ServerWebExchange : WebFlux环境
    UserContextUtil --> HttpServletRequest : Servlet环境
```

**功能特色：**

- **双环境支持**：同时支持WebFlux和Servlet环境
- **类型安全**：使用Optional避免空指针异常
- **便捷方法**：提供常用的权限判断快捷方法
- **上下文构建**：能够从请求头重建完整的AuthUser对象

### 3.3 AuthenticationFilter 过滤器

```mermaid
classDiagram
    class AuthenticationFilter {
        -String[] AUTH_WHITELIST

        +doFilterInternal(HttpServletRequest, HttpServletResponse, FilterChain) void
    }

    class OncePerRequestFilter {
        <<abstract>>
        +doFilterInternal(HttpServletRequest, HttpServletResponse, FilterChain) void
    }

    class Configuration {
        <<annotation>>
    }

    class ConditionalOnWebApplication {
        <<annotation>>
        +type() Type
    }

    class UserContextUtil {
        +getCurrentAuthUser(HttpServletRequest) Optional~AuthUser~
    }

    class SecurityContextHolder {
        +getContext() SecurityContext
        +clearContext() void
    }

    AuthenticationFilter --|> OncePerRequestFilter
    AuthenticationFilter --> Configuration
    AuthenticationFilter --> ConditionalOnWebApplication
    AuthenticationFilter --> UserContextUtil
    AuthenticationFilter --> SecurityContextHolder
```

**处理流程：**

1. **白名单检查**：跳过公开路径的权限验证
2. **请求头解析**：从HTTP头中提取用户信息
3. **上下文构建**：构建AuthUser对象和Authentication
4. **上下文设置**：将认证信息设置到SecurityContext
5. **请求处理**：继续处理业务请求
6. **上下文清理**：请求结束后清理认证上下文

## 4. 异常处理模块

### 4.1 Servlet 异常处理器

```mermaid
classDiagram
    class GlobalExceptionHandler {
        +handleValidationException(MethodArgumentNotValidException) ResponseEntity~ResponseResult~
        +handleBindException(BindException) ResponseEntity~ResponseResult~
        +handleConstraintViolationException(ConstraintViolationException) ResponseEntity~ResponseResult~
        +handleBizException(BizException) ResponseEntity~ResponseResult~
        +handleAccessDeniedException(AccessDeniedException) ResponseEntity~ResponseResult~
        +handleException(Exception) ResponseEntity~ResponseResult~
    }

    class RestControllerAdvice {
        <<annotation>>
    }

    class ExceptionHandler {
        <<annotation>>
        +value() Class[]
    }

    class ResponseStatus {
        <<annotation>>
        +value() HttpStatus
    }

    GlobalExceptionHandler --> RestControllerAdvice
    GlobalExceptionHandler --> ExceptionHandler
    GlobalExceptionHandler --> ResponseStatus
```

### 4.2 WebFlux 异常处理器

```mermaid
classDiagram
    class GlobalExceptionHandlerWebFlux {
        +handleValidationException(WebExchangeBindException) Mono~ResponseEntity~ResponseResult~~
        +handleBizException(BizException) Mono~ResponseEntity~ResponseResult~~
        +handleAccessDeniedException(AccessDeniedException) Mono~ResponseEntity~ResponseResult~~
        +handleException(Exception) Mono~ResponseEntity~ResponseResult~~
    }

    class ControllerAdvice {
        <<annotation>>
    }

    class ExceptionHandler {
        <<annotation>>
        +value() Class[]
    }

    class ConditionalOnWebApplication {
        <<annotation>>
        +type() Type
    }

    GlobalExceptionHandlerWebFlux --> ControllerAdvice
    GlobalExceptionHandlerWebFlux --> ExceptionHandler
    GlobalExceptionHandlerWebFlux --> ConditionalOnWebApplication
```

## 5. 模块交互流程

### 5.1 认证流程时序图

```mermaid
sequenceDiagram
    participant R as Request
    participant AGF as AuthGlobalFilter
    participant AFC as AuthFeignClient
    participant AS as AuthService
    participant BS as BusinessService
    participant AF as AuthenticationFilter
    participant UC as UserContextUtil
    participant SC as SecurityContext

    R->>+AGF: 1. 请求 + JWT Token
    AGF->>AGF: 2. 检查公开路径
    AGF->>+AFC: 3. 验证Token
    AFC->>+AS: 4. OpenFeign调用
    AS->>AS: 5. JWT验证 + 用户查询
    AS->>-AFC: 6. 返回AuthUser
    AFC->>-AGF: 7. 返回用户信息
    AGF->>AGF: 8. 注入用户信息头
    AGF->>+BS: 9. 转发请求

    BS->>+AF: 10. 请求到达下游
    AF->>AF: 11. 检查白名单
    AF->>+UC: 12. 解析请求头
    UC->>-AF: 13. 构建AuthUser
    AF->>+SC: 14. 设置SecurityContext
    SC->>-AF: 15. 认证上下文已设置
    AF->>BS: 16. 继续请求处理

    BS->>BS: 17. 业务逻辑执行
    BS->>-AGF: 18. 返回响应
    AGF->>-R: 19. 最终响应

    Note over SC: 请求结束后自动清理
```

### 5.2 权限检查流程

```mermaid
flowchart TD
    A[业务方法调用] --> B{使用@PreAuthorize?}
    B -->|是| C[Spring Security拦截]
    B -->|否| D[直接执行方法]

    C --> E[获取SecurityContext]
    E --> F[提取Authentication]
    F --> G[获取AuthUser Principal]
    G --> H[执行权限表达式]

    H --> I{权限验证通过?}
    I -->|是| J[执行业务方法]
    I -->|否| K[抛出AccessDeniedException]

    J --> L[返回业务结果]
    K --> M[异常处理器处理]
    M --> N[返回403响应]

    D --> O[使用UserContextUtil]
    O --> P[从请求头获取用户信息]
    P --> Q[执行业务逻辑]
    Q --> L
```

## 6. 关键设计模式

### 6.1 过滤器链模式

```mermaid
classDiagram
    class FilterChain {
        <<interface>>
        +doFilter(Request, Response) void
    }

    class AuthGlobalFilter {
        +filter(ServerWebExchange, GatewayFilterChain) Mono~Void~
        +getOrder() int
    }

    class AuthenticationFilter {
        +doFilterInternal(HttpServletRequest, HttpServletResponse, FilterChain) void
    }

    class GlobalFilter {
        <<interface>>
    }

    class OncePerRequestFilter {
        <<abstract>>
    }

    AuthGlobalFilter --|> GlobalFilter
    AuthenticationFilter --|> OncePerRequestFilter
    FilterChain <-- AuthGlobalFilter
    FilterChain <-- AuthenticationFilter
```

### 6.2 工厂模式

```mermaid
classDiagram
    class UserContextUtil {
        +getCurrentAuthUser(HttpServletRequest) Optional~AuthUser~
        +getCurrentAuthUser(ServerWebExchange) Optional~AuthUser~
    }

    class AuthUserBuilder {
        +userId(Long) AuthUserBuilder
        +username(String) AuthUserBuilder
        +email(String) AuthUserBuilder
        +role(Role) AuthUserBuilder
        +build() AuthUser
    }

    class Role {
        +builder() RoleBuilder
    }

    UserContextUtil --> AuthUserBuilder
    AuthUserBuilder --> Role
```

---

**上一章节：** [02-架构设计.md](./02-架构设计.md)
**下一章节：** [04-使用示例.md](./04-使用示例.md)
