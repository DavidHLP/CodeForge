# SpringOJ 微服务权限信息传递系统 - 架构设计

## 1. 整体系统架构

### 1.1 系统架构图

```mermaid
graph TB
    subgraph "客户端层"
        A[Web前端] --> B[移动端]
        B --> C[第三方客户端]
    end

    subgraph "网关层"
        D[Spring Cloud Gateway<br/>统一入口]
        D --> E[AuthGlobalFilter<br/>全局认证过滤器]
        E --> F[SecurityConfiguration<br/>安全配置]
    end

    subgraph "认证服务"
        G[Authentication Service<br/>用户认证服务]
        G --> H[JWT Token验证]
        G --> I[用户信息查询]
    end

    subgraph "业务服务集群"
        J[User Service<br/>用户服务]
        K[Problem Service<br/>题目服务]
        L[Judge Service<br/>判题服务]
        M[其他业务服务...]
    end

    subgraph "公共组件"
        N[security-commons<br/>安全组件]
        O[servlet-commons<br/>Servlet组件]
        P[webflux-commons<br/>WebFlux组件]
    end

    subgraph "基础设施"
        Q[Nacos<br/>服务注册中心]
        R[Sentinel<br/>流量治理]
        S[数据库集群]
    end

    A --> D
    C --> D
    E --> G
    D --> J
    D --> K
    D --> L
    D --> M

    J --> N
    K --> N
    L --> N
    M --> N

    N --> O
    N --> P

    D --> Q
    J --> Q
    K --> Q
    L --> Q

    D --> R
    G --> S
    J --> S
    K --> S
```

### 1.2 权限信息传递流程

```mermaid
sequenceDiagram
    participant C as 客户端
    participant G as Gateway
    participant A as Auth Service
    participant B as Business Service
    participant S as Security Context

    C->>+G: 1. 发送请求 + JWT Token
    Note over G: AuthGlobalFilter处理

    G->>+A: 2. 验证Token (OpenFeign)
    A->>A: 3. 解析JWT + 查询用户信息
    A->>-G: 4. 返回AuthUser对象

    Note over G: 注入用户信息到请求头
    G->>G: 5. 添加X-User-*请求头

    G->>+B: 6. 转发请求 + 用户信息头
    Note over B: AuthenticationFilter处理

    B->>B: 7. 解析请求头构建AuthUser
    B->>+S: 8. 设置SecurityContext
    S->>-B: 9. 认证上下文已设置

    B->>B: 10. 执行业务逻辑
    B->>-G: 11. 返回业务结果
    G->>-C: 12. 返回最终响应

    Note over S: 请求结束清理上下文
```

## 2. 网关层架构设计

### 2.1 Gateway 组件架构

```mermaid
graph LR
    subgraph "Spring Cloud Gateway"
        A[Route Predicates<br/>路由断言] --> B[Gateway Filters<br/>网关过滤器]
        B --> C[Global Filters<br/>全局过滤器]

        subgraph "全局过滤器链"
            C --> D[AuthGlobalFilter<br/>-100 最高优先级]
            D --> E[其他系统过滤器...]
        end

        subgraph "路由过滤器"
            F[Retry Filter<br/>重试过滤器]
            G[LoadBalancer Filter<br/>负载均衡]
            H[Hystrix Filter<br/>熔断过滤器]
        end
    end

    subgraph "认证流程"
        I[Token 提取] --> J[OpenFeign 调用]
        J --> K[用户信息注入]
        K --> L[请求转发]
    end

    D --> I
    L --> F
```

### 2.2 安全配置架构

```mermaid
graph TB
    subgraph "SecurityConfiguration"
        A[WebFlux Security Chain]
        A --> B[禁用CSRF]
        A --> C[禁用Form Login]
        A --> D[禁用HTTP Basic]
        A --> E[无状态会话]
        A --> F[路径权限配置]

        subgraph "公开路径"
            G["/actuator/**"]
            H["/api/auth/**"]
            I["/favicon.ico"]
            J["/error"]
        end

        F --> G
        F --> H
        F --> I
        F --> J
    end

    subgraph "AuthGlobalFilter"
        K[请求拦截] --> L[路径检查]
        L --> M[Token验证]
        M --> N[用户信息注入]
        N --> O[请求转发]

        L -.-> P[公开路径直接放行]
        M -.-> Q[认证失败返回401]
    end
```

## 3. 权限传递机制设计

### 3.1 HTTP 头字段规范

```mermaid
graph LR
    subgraph "JWT Token"
        A[Authorization: Bearer <token>]
    end

    subgraph "用户信息头字段"
        B[X-User-Id: 用户ID]
        C[X-User-Name: 用户名]
        D[X-User-Email: 邮箱地址]
        E[X-User-Roles: 角色信息]
    end

    subgraph "Gateway处理"
        F[AuthGlobalFilter]
        F --> G[Token解析]
        G --> H[OpenFeign调用]
        H --> I[用户信息注入]
    end

    A --> F
    I --> B
    I --> C
    I --> D
    I --> E
```

### 3.2 下游服务接收机制

```mermaid
graph TB
    subgraph "请求到达下游服务"
        A[HTTP Request + Headers]
    end

    subgraph "AuthenticationFilter 处理"
        B[OncePerRequestFilter]
        B --> C[白名单路径检查]
        C --> D[请求头解析]
        D --> E[AuthUser 构建]
        E --> F[SecurityContext 设置]
    end

    subgraph "业务代码使用"
        G[UserContextUtil 工具类]
        H[SecurityContextHolder]
        I["@PreAuthorize 注解"]
        J[方法级权限控制]
    end

    subgraph "上下文清理"
        K[请求结束]
        K --> L[SecurityContext.clear]
    end

    A --> B
    F --> G
    F --> H
    F --> I
    F --> J
    J --> K
```

## 4. 服务间通信架构

### 4.1 OpenFeign 集成设计

```mermaid
graph LR
    subgraph "Gateway 服务"
        A[AuthGlobalFilter] --> B[AuthFeignClient]
        B --> C["@FeignClient注解"]
        C --> D[LoadBalancer]
    end

    subgraph "认证服务"
        E[AuthController]
        E --> F["/api/auth/validate/{token}"]
        F --> G[JWT验证逻辑]
        G --> H[用户信息查询]
        H --> I[ResponseResult<AuthUserInfo>]
    end

    subgraph "服务发现"
        J[Nacos Registry]
        J --> K[authentication服务实例]
        K --> L[负载均衡策略]
    end

    D --> J
    B --> E
    I --> A
```

### 4.2 异常处理机制

```mermaid
graph TB
    subgraph "Gateway 异常处理"
        A[AuthGlobalFilter] --> B[认证异常捕获]
        B --> C[handleUnauthorized方法]
        C --> D[设置401状态码]
        D --> E[JSON格式响应]
    end

    subgraph "下游服务异常处理"
        F[GlobalExceptionHandler] --> G[BizException处理]
        F --> H[ValidationException处理]
        F --> I[AccessDeniedException处理]
        G --> J[统一响应格式]
        H --> J
        I --> J
    end

    subgraph "WebFlux 异常处理"
        K[GlobalExceptionHandlerWebFlux] --> L[响应式异常处理]
        L --> M[Mono<ResponseEntity>]
    end
```

## 5. 技术栈架构

### 5.1 核心技术栈

```mermaid
graph TB
    subgraph "网关层技术栈"
        A[Spring Cloud Gateway 4.0+]
        B[Spring WebFlux 6.0+]
        C[Spring Security 6.1+]
        D[OpenFeign 4.0+]
        E[Reactor Netty]
    end

    subgraph "公共组件技术栈"
        F[Spring Boot 3.1+]
        G[Spring Security 6.1+]
        H[MyBatis Plus 3.5+]
        I[Jakarta EE 9+]
    end

    subgraph "微服务技术栈"
        J[Spring Cloud 2023.0+]
        K[Nacos 2.3+]
        L[Sentinel 1.8+]
        M[LoadBalancer 4.0+]
    end

    subgraph "基础设施"
        N[Java 17+]
        O[Maven 3.9+]
        P[MySQL 8.0+]
        Q[Redis 7.0+]
    end

    A --> F
    B --> F
    C --> F
    D --> J
    F --> N
    J --> K
    J --> L
```

### 5.2 部署架构

```mermaid
graph TB
    subgraph "容器化部署"
        A[Docker Images]
        A --> B[Gateway Service]
        A --> C[Auth Service]
        A --> D[Business Services]
    end

    subgraph "服务编排"
        E[Kubernetes / Docker Compose]
        E --> F[Service Discovery]
        E --> G[Config Management]
        E --> H[Load Balancing]
    end

    subgraph "监控运维"
        I[Actuator Endpoints]
        J[Prometheus Metrics]
        K[Grafana Dashboard]
        L[Log Aggregation]
    end

    B --> E
    C --> E
    D --> E
    E --> I
    I --> J
    J --> K
```

## 6. 性能与扩展性设计

### 6.1 高并发处理架构

```mermaid
graph LR
    subgraph "请求处理流程"
        A[Incoming Requests] --> B[Netty EventLoop]
        B --> C[WebFlux Handler]
        C --> D[非阻塞认证]
        D --> E[异步服务调用]
        E --> F[响应返回]
    end

    subgraph "线程模型"
        G[Event Loop Threads<br/>处理I/O事件]
        H[Scheduler Threads<br/>处理阻塞调用]
        I[Worker Threads<br/>业务逻辑处理]
    end

    B --> G
    D --> H
    E --> I
```

### 6.2 可扩展性设计

```mermaid
graph TB
    subgraph "水平扩展"
        A[Gateway Instances] --> B[负载均衡器]
        C[Auth Service Cluster] --> D[数据库集群]
        E[Business Service Cluster] --> F[缓存集群]
    end

    subgraph "垂直扩展"
        G[资源配置优化]
        H[JVM参数调优]
        I[连接池配置]
        J[缓存策略优化]
    end

    B --> C
    D --> F
```

## 7. 安全架构设计

### 7.1 多层安全防护

```mermaid
graph TB
    subgraph "网络层安全"
        A[HTTPS/TLS] --> B[网络隔离]
        B --> C[防火墙规则]
    end

    subgraph "应用层安全"
        D[JWT Token认证] --> E[权限验证]
        E --> F[请求签名校验]
    end

    subgraph "数据层安全"
        G[数据加密] --> H[敏感信息脱敏]
        H --> I[审计日志]
    end

    A --> D
    D --> G
```

---

**上一章节：** [01-项目概述.md](./01-项目概述.md)  
**下一章节：** [03-核心模块.md](./03-核心模块.md)
